# ============================================================
# GitHub Actions: Actualizaci√≥n Autom√°tica de Noticias
# ============================================================
# 
# Este workflow ejecuta el pipeline cada 3 horas en modo SIN IA:
# 1. Extrae noticias de RSS (8 fuentes argentinas)
# 2. Normaliza fechas y clasifica por categor√≠a
# 3. Integra todas las fuentes en un √∫nico JSON diario
# 4. Copia el JSON del d√≠a a frontend/data/
# ============================================================

name: Actualizar noticias cada 3h

# Ejecutar cada 3 horas y tambi√©n manualmente
on:
  schedule:
    - cron: "0 */3 * * *"  # cada 3 horas en minuto 0 (UTC)
  workflow_dispatch:      # permite lanzar manualmente desde Actions UI

permissions:
  contents: write   # necesario para que el workflow pueda hacer push (usa GITHUB_TOKEN)

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Timeout de seguridad (pipeline tarda ~8-12 min)
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # obtener todo el historial (recomendado para commits)
          persist-credentials: true  # permitir push con el token provisto

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pipeline (modo sin IA)
        run: |
          python scripts/ejecutar_pipeline.py

      - name: Show generated files (debug)
        run: |
          echo "=== Archivos en frontend/data/ ==="
          ls -lh frontend/data/ || echo "Directorio no encontrado"
          echo ""
          echo "=== Git status ==="
          git status --porcelain

      - name: Clean old files from frontend/data
        run: |
          # Obtener fecha actual (UTC-3 Argentina para coincidir con el pipeline)
          FECHA_HOY=$(TZ='America/Argentina/Buenos_Aires' date +%Y-%m-%d)
          echo "Fecha actual (Argentina): $FECHA_HOY"
          
          # Eliminar archivos de noticias y res√∫menes de fechas anteriores
          cd frontend/data
          find . -name "noticias_*.json" ! -name "noticias_$FECHA_HOY.json" -type f -delete 2>/dev/null || true
          find . -name "resumenes_*.json" ! -name "resumenes_$FECHA_HOY.json" -type f -delete 2>/dev/null || true
          echo "‚úì Archivos antiguos eliminados (se mantiene solo $FECHA_HOY)"

      - name: Commit & push changes
        run: |
          # Configurar Git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # A√±adir todos los archivos de frontend/data/
          git add frontend/data/*.json || true
          
          # Comprobar si hay cambios
          if git diff --cached --quiet; then
            echo "‚úì No hay cambios para commitear"
          else
            # Generar timestamp para el commit
            TIMESTAMP=$(TZ='America/Argentina/Buenos_Aires' date '+%Y-%m-%d %H:%M %Z')
            
            # Commit y push
            git commit -m "ü§ñ Update: noticias [$TIMESTAMP] [ci skip]" || echo "‚ö†Ô∏è Commit fall√≥"
            git push origin HEAD:main || echo "‚ö†Ô∏è Push fall√≥"
            echo "‚úì Cambios publicados"
          fi
